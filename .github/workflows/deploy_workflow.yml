name: deploy_workflow
on:
  push:
    branches: ["master"]

env:
    CR_REGISTRY: ${{ secrets.CR_REGISTRY }}
    CR_REPOSITORY: tesser
#    IMAGE_TAG: ${{ github.sha }}
    IMAGE_TAG: latest

jobs:
    run-linters:
      name: Linters
      runs-on: ubuntu-latest
      continue-on-error: true

      steps:
        - name: Check out Git repository
          uses: actions/checkout@v2

        - name: Set up Python
          uses: actions/setup-python@v1
          with:
            python-version: 3.11

        - name: Install Python dependencies
          run: pip install black flake8 mypy

        - name: Run linters
          uses: wearerequired/lint-action@v2
          with:
            black: true
            flake8: true
            mypy: true

    build:
        runs-on: ubuntu-latest
        name: Testing
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Build
              run: docker build --tag cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG .

            - name: Test
              run:  docker run cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG /usr/local/bin/python -m pytest


            - name: Login to Yandex Cloud Container Registry
              id: login-cr
              uses: yc-actions/yc-cr-login@v1
              with:
                  yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

            - name: Push Image To YC
              run: docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG

    deploy:
        name: Deploy Serverless Container
        runs-on: ubuntu-latest
        steps:
          - name: Deploy
            uses: yc-actions/yc-sls-container-deploy@v2
            with:
              yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
              container-name: worddetector-test
              folder-id: ${{ secrets.FOLDER_ID }}
              revision-service-account-id: ${{ secrets.SERVICE_ACCOUNT_ID }}
              revision-cores: 1
              revision-memory: 512Mb
              revision-core-fraction: 100
              revision-concurrency: 8
#              revision-image-url: cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG
              revision-image-url: cr.yandex/crp5td2ej9d9m9e880v2/tesser:f258d2ad31a0992c70ab99358037ce6aa20ee445
              revision-execution-timeout: 10
